name: deployment

kind: pipeline


steps:
  - name: restore-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./vendor
    commands:
      - echo "restore cache"

  - name: build
    image: golang:1.14
    commands:
      - go env -w GOPROXY=https://goproxy.cn,direct
      - go mod vendor -v
      - make build_linux_amd64

  - name: rsync
    image: drillster/drone-rsync
    environment:
      RSYNC_KEY:
        from_secret: rsync_key
      RSYNC_USER: deployer
      PLUGIN_TARGET: /var/www/codes/docker/sites/trading-central-playlists
    settings:
      hosts:
        - 172.16.11.15
      source: ./
      include:
        - "**.*"
      exclude:
        - "app.production.yml"
      script:
        - cd ${PLUGIN_TARGET} && ls -la


  - name: rebuild-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./vendor
    commands:
      - echo "rebuild cache"
    when:
      branch:
        - stage
        - master

volumes:
  - name: cache
    host:
      path: /tmp/drone/cache
