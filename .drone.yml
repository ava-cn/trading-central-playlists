name: deployment

kind: pipeline


steps:
  - name: restore-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./vendor
    commands:
      - echo "restore cache"

  - name: build
    image: golang:1.14
    commands:
      - go env -w GOPROXY=https://goproxy.cn,direct
      - go mod vendor -v
      - make build_linux_amd64

  - name: rsync
    image: drillster/drone-rsync
    environment:
      RSYNC_KEY:
        from_secret: rsync_key
      RSYNC_USER: deployer
      PLUGIN_TARGET: /var/www/codes/docker/sites/trading-central-playlists
    settings:
      hosts:
        - 172.16.11.15
      source: ./
      include:
        - "**.*"
      exclude:
        - "app.*.yml"
      script:
        - cd ${PLUGIN_TARGET} && ls -la

  - name: rebuild-and-reload-docker
    image: appleboy/drone-ssh
    settings:
      host: 172.16.11.15
      username: deployer
      port: 22
      key:
        from_secret: rsync_key
      script:
        - cd /var/www/codes/docker/sites/trading-central-playlists
        - echo "rebuild docker image"
        - sh -x run.sh
        - echo "reload docker-compose containers"
        - sudo systemctl start docker-compose-trading-central-playlists
        - echo "check docker-compose status"
        - sudo systemctl status docker-compose-trading-central-playlists

  - name: rebuild-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./vendor
    when:
      branch:
        - stage
        - master

volumes:
  - name: cache
    host:
      path: /tmp/drone/cache
